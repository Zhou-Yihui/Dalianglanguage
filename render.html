<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>雅言字符渲染器</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body { background:#0b0c2a; color:#fff; font-family:"Microsoft YaHei"; text-align:center; margin:0; padding:20px; }
  canvas { background:#111; border:1px solid #f0c000; border-radius:6px; margin-top:10px; }
  select, button { margin:8px; padding:8px 16px; border:none; border-radius:6px; cursor:pointer; font-size:15px; }
  button:hover { opacity:0.9; }
  #renderBtn { background:#f0c000; color:#000; }
</style>
</head>
<body>
  <h2>🌌 雅言字符渲染器</h2>
  <select id="charSelect"></select>
  <button id="renderBtn">渲染字符</button>
  <button id="exportBtn">导出并上传</button> <!-- 新增上传按钮 -->
  <canvas id="canvas" width="300" height="300"></canvas>

<script>
// 原始渲染功能
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let allChars = JSON.parse(localStorage.getItem("stargate_chars")) || { chars: [] };

const charSelect = document.getElementById("charSelect");
function updateCharSelect() {
  charSelect.innerHTML = "";
  allChars.chars.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c.name;
    opt.textContent = c.name;
    charSelect.appendChild(opt);
  });
}
updateCharSelect();

// 渲染函数：缩放、居中、平滑、印刷体风格
function renderChar(strokes, width, height) {
  if (!strokes || strokes.length === 0) {
    ctx.clearRect(0, 0, width, height);
    return;
  }

  // 计算最小外接矩形
  let xs = [], ys = [];
  strokes.forEach(stroke => stroke.forEach(p => { xs.push(p.x); ys.push(p.y); }));
  const minX = Math.min(...xs), maxX = Math.max(...xs);
  const minY = Math.min(...ys), maxY = Math.max(...ys);

  const charWidth = maxX - minX;
  const charHeight = maxY - minY;
  const scale = Math.min(width / charWidth, height / charHeight) * 0.8;
  const offsetX = (width - charWidth * scale) / 2 - minX * scale;
  const offsetY = (height - charHeight * scale) / 2 - minY * scale;

  // 绘制笔画
  ctx.clearRect(0, 0, width, height);
  ctx.strokeStyle = "#f0c000";
  ctx.lineWidth = 2;
  ctx.lineJoin = "round";
  ctx.lineCap = "round";

  strokes.forEach(stroke => {
    if (stroke.length === 0) return;
    ctx.beginPath();
    ctx.moveTo(stroke[0].x * scale + offsetX, stroke[0].y * scale + offsetY);
    for (let i = 1; i < stroke.length; i++) {
      // 平滑曲线
      const prev = stroke[i - 1];
      const curr = stroke[i];
      const midX = (prev.x + curr.x) / 2;
      const midY = (prev.y + curr.y) / 2;
      ctx.quadraticCurveTo(prev.x * scale + offsetX, prev.y * scale + offsetY, midX * scale + offsetX, midY * scale + offsetY);
    }
    ctx.stroke();
  });
}

// 点击渲染按钮
document.getElementById("renderBtn").addEventListener("click", () => {
  const selectedName = charSelect.value;
  const charObj = allChars.chars.find(c => c.name === selectedName);
  if (!charObj) return alert("字符不存在！");
  renderChar(charObj.strokes, canvas.width, canvas.height);
});

// 上传功能
async function exportAndUpload() {
  try {
    const jsonData = JSON.stringify(allChars, null, 2);
    const blob = new Blob([jsonData], { type: 'application/json' });
    const fileName = 'stargate_chars.json';

    // 本地导出
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = fileName;
    a.click();

    // GitHub 上传配置
    const githubToken = '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';  // 你的 Token
    const repoOwner = 'zhou-yihui';
    const repoName = 'Dalianglanguage';  // 替换为你实际的仓库名
    const uploadPath = 'data/' + fileName;

    // 检查文件是否存在
    const checkResp = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${uploadPath}`, {
      headers: { Authorization: `token ${githubToken}` }
    });

    let sha = null;
    if (checkResp.ok) {
      const existing = await checkResp.json();
      sha = existing.sha;
    }

    // 上传文件
    const uploadResp = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${uploadPath}`, {
      method: 'PUT',
      headers: {
        Authorization: `token ${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}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: 'Auto upload from Daliang IME system',
        content: btoa(unescape(encodeURIComponent(jsonData))),
        sha: sha || undefined
      })
    });

    if (uploadResp.ok) {
      alert('✅ 上传成功！文件已同步到 GitHub。');
    } else {
      alert('⚠️ 上传失败：' + uploadResp.status);
    }

  } catch (err) {
    console.error(err);
    alert('❌ 出错：' + err.message);
  }
}

// 绑定导出并上传按钮
document.getElementById('exportBtn').addEventListener('click', exportAndUpload);
</script>
</body>
</html>
